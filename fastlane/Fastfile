# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

# fastlane/Fastfile
# This is the configuration for automating Android builds and deployments

default_platform(:android)

platform :android do

  # ===========================
  # LANE: verify
  # Purpose: Run tests and code quality checks
  # ===========================
  desc "Run unit tests, lint checks, and code quality analysis"
  lane :verify do
    # Clean previous builds
    gradle(task: "clean")

     # Run unit tests for Dev flavor
     gradle(
     task: "testDebugUnitTest",
    )

    # Run lint checks
    gradle(
      task: ":app:lintDebug",
    )

    # Optional: Run detekt for Kotlin static analysis
    # gradle(task: "detekt")

    UI.success(" All verification checks passed!")
  end

  # ===========================
  # LANE: sonarqube
  # Purpose: Run SonarQube code quality analysis
  # ===========================
  desc "Run SonarQube code quality scan"
  lane :sonarqube do
    gradle(
      task: "sonar",
      properties: {
        "sonar.host.url" => ENV['SONAR_HOST_URL'],
        "sonar.login" => ENV['SONAR_TOKEN'],
        "sonar.projectKey" => ENV['SONAR_PROJECT_KEY']
      }
    )
    UI.success(" SonarQube scan completed!")
  end

  # ===========================
  # LANE: build_dev
  # Purpose: Build Dev APK
  # ===========================
  desc "Build Dev APK"
  lane :build_dev do
    # Load environment variables for Dev
    Dotenv.load('.env.dev')

    gradle(
      task: "assemble",
      flavor: "Dev",
      build_type: "Release",
      properties: {
        "android.injected.signing.store.file" => ENV['KEYSTORE_FILE'],
        "android.injected.signing.store.password" => ENV['KEYSTORE_PASSWORD'],
        "android.injected.signing.key.alias" => ENV['KEY_ALIAS'],
        "android.injected.signing.key.password" => ENV['KEY_PASSWORD']
      }
    )

    UI.success(" Dev APK built successfully!")
  end

  # ===========================
  # LANE: deploy_dev
  # Purpose: Deploy Dev build to Firebase App Distribution
  # ===========================
  desc "Build and distribute APK to Firebase"
    lane :distribute_apk do
      # Build your APK
      gradle(
        task: "assemble",
        build_type: "Release"
      )

      # Upload to Firebase App Distribution
      firebase_app_distribution(
        app: "1:732552016910:android:a19f926982c535a033785f",  # Firebase App ID
        apk_path: "app/build/outputs/apk/release/app-release-unsigned.apk",
        testers: "tester1@example.com, tester2@example.com",  # Comma-separated emails
        release_notes: "New release with bug fixes and improvements",
      )
    end

    desc "Build and distribute with dynamic release notes"
    lane :distribute_with_notes do |options|
      gradle(
        task: "assemble",
        build_type: "Release"
      )

      firebase_app_distribution(
        app: ENV["FIREBASE_APP_ID"],  # Use environment variable
        apk_path: "app/build/outputs/apk/release/app-release.apk",
        testers_file: "fastlane/testers.txt",  # File with emails, one per line
        release_notes: options[:notes] || "Latest build",
        firebase_cli_token: ENV["FIREBASE_TOKEN"]  # For CI/CD
      )
    end


  # ===========================
  # LANE: full_pipeline
  # Purpose: Complete pipeline - verify, build, and deploy
  # ===========================
  desc "Run complete pipeline: verify → build → deploy"
  lane :full_pipeline do
    verify
    deploy_dev
  end

  # ===========================
  # ERROR HANDLING
  # ===========================
  error do |lane, exception|
    UI.error(" Error in lane #{lane}: #{exception.message}")
    # )
  end
end
